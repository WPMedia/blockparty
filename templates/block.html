{% extends 'base.html' %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='block.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='code.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='node_modules/codemirror/lib/codemirror.css') }}">
{% endblock %}

{% block content %}
<div id="drop"></div>
<div id="files">
<p class="top">block {{ block._id }} <a class='right' href='/'>(home)</a></p>
{% if index %}
	<div class="file">
		<iframe src="{{ index.path }}" frameborder="0"></iframe>
		<a class='right' target='_blank' href="{{ index.path }}">open in new tab</a>
	</div>
{% endif %}
{% if readme %}
	<div class="file">
		{{ readme.content | markdown }}
	</div>
{% endif %}
{% for file in files %}
	<div class="file">
		<p><a href='{{ file.path }}'>{{ file.name }}</a>  <a href="{{ file.path }}" class="right delete">(delete) </a></p>
		<form action="{{ file.path }}" method="POST">
			<textarea name='content' class='code'>{{ file.content }}</textarea>
			<input type="submit" value='save'>
		</form>
	</div>
{% endfor %}
</div>
{% endblock %}

{% block javascript %}
<script src="{{ url_for('static', filename='drag-add.js') }}"></script>
<script src="{{ url_for('static', filename='delete.js') }}"></script>
<script src="{{ url_for('static', filename='node_modules/codemirror/lib/codemirror.js') }}"></script>
<script>
var saves = document.getElementsByClassName('save');
Array.prototype.forEach.call(saves, function(el) {
	el.addEventListener('click', function(ev) {
		ev.preventDefault();
		console.log('hey');
		var xhr = new XMLHttpRequest();
		xhr.open('POST', el.href);
		xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		var textarea = el.parentElement.getElementsByTagName('textarea')[0];
		console.log(textarea);
		xhr.send(JSON.stringify({'content': textarea.value}));
	})
});

var codes = document.getElementsByClassName('code');
Array.prototype.forEach.call(codes, function(el) {
	var editor = CodeMirror.fromTextArea(el, {
		lineNumbers: true, 
		mode: 'htmlmixed', 
        tabMode: "indent",
        stylesheet: "static/node_modules/codemirror/theme/solarized.css" 
    });
	editor.on('change', function(e) {
		e.save();
		console.log('changed', e);
		console.log(e.getTextArea());
	})
    editor.on('blur', function(e){
    	e.save();
    })
});
</script>
{% endblock %}
